<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Testing Async functions in Mocha &#8211; UTF-9000</title> <meta name="description" content="Learn You An Async For Great Good"> <meta name="keywords" content="Javascript, Node, Testing"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="http://localhost:4000//assets/img/covers/mocha.jpg"> <meta name="twitter:title" content="Testing Async functions in Mocha"> <meta name="twitter:description" content="Learn You An Async For Great Good"> <meta name="twitter:site" content="@sentreh"> <meta name="twitter:creator" content="@sentreh"> <!-- Open Graph --> <meta property="og:locale" content="en_NZ"> <meta property="og:type" content="article"> <meta property="og:title" content="Testing Async functions in Mocha"> <meta property="og:description" content="Learn You An Async For Great Good"> <meta property="og:url" content="http://localhost:4000/2017/async/"> <meta property="og:site_name" content="UTF-9000"> <meta property="og:image" content="http://localhost:4000/images/halve.png"> <link rel="canonical" href="http://localhost:4000/2017/async/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- Apple icons --> <link href="http://localhost:4000/images/apple-icon.png" rel="apple-touch-icon" /> <link href="http://localhost:4000/images/apple-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" /> <link href="http://localhost:4000/images/apple-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" /> <link href="http://localhost:4000/images/apple-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" /> <link href="http://localhost:4000/images/icon-hires.png" rel="icon" sizes="192x192" /> <link href="http://localhost:4000/images/icon-normal.png" rel="icon" sizes="128x128" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000//assets/img/covers/mocha.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/home.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/halve.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Testing Async functions in Mocha </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#Javascript">Javascript</a></li> <li><a href="http://localhost:4000/tags#Node">Node</a></li> <li><a href="http://localhost:4000/tags#Testing">Testing</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="inner-post content"> <div class="date-highlight">04 Jun 2017</div> <p>Do you know what day it is? One month until Independence Day? Nope, it’s nothing actually, I just wanted to check that you weren’t forgetting anything.</p> <p>In other news, I finally tried to write some tests for <a href="https://github.com/marcus-crane/pkgparse">pkgparse</a>, the module that I use to test out new Node features or styles of writing things.</p> <p>I changed it to use async/await instead of promises to celebrate the release of Node <a href="https://nodejs.org/en/blog/release/v8.0.0/">v8.0.0</a>.</p> <p>Now, you might say that async/await has been in Node since 7.7.4 which, yes that’s true but 8.X.X is the next Long Term Support version!</p> <p>The team haven’t said explicitly that it’s 8.0.0 itself but I imagine we’ll start to see it looked at more until, and especially after the LTS version is announced</p> <p>I haven’t put in 1000 hours of testing time yet so writing tests is still something I’m learning a lot about but testing async functions is definitely a new one for me. That is to say, I’ve tested promises but in order to await the function you’re testing, the actual test function needs to use await.</p> <p>Well, just use <code class="highlighter-rouge">done()</code> I hear you say but the trouble I had was that using <code class="highlighter-rouge">expect()</code> followed by <code class="highlighter-rouge">done()</code> is mixing promises and callbacks which is a no, no according to mocha. There were a few comments around suggesting that so I don’t know what the problem was.</p> <p>Here’s what I’ve since learnt anyway. We’ll use the following function as a test example:</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">fetchDependenciesFromNPM</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">JSONObjectFromNPM</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">axios</span><span class="p">(</span><span class="s1">'https://registry.npmjs.org/'</span> <span class="o">+</span> <span class="nx">moduleName</span><span class="p">)</span>
    <span class="c1">// some filtering here blah blah</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dependenciesExist</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">dependencies</span> <span class="c1">// eg; ['mocha', 'express', 'axios']</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">[]</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">}</span> <span class="nx">$</span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
  <span class="p">}</span>  
<span class="p">}</span>
</code></pre></div> <p>Most of this we can ignore for this example. The only things we need to know is that this function takes the name of a module as a string eg: <code class="highlighter-rouge">express</code> and returns its NPM dependencies as an array.</p> <p>If there’s not dependencies at all, it just sends back an empty array instead. In reality, pkgparse uses a Set but I’m still figuring out how to deal with the contents of a Set that has no keys. Testing its size/length is easy enough.</p> <p>Anyway, I’m getting sidetracked here. Here’s how I’m currently testing the above function:</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should return the dependencies of a given NPM module'</span><span class="p">,</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">dependencies</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetchDependenciesFromNPM</span><span class="p">(</span><span class="s1">'yourfavemodule'</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">equal</span><span class="p">([</span> <span class="s1">'eslint'</span><span class="p">,</span> <span class="s1">'react'</span><span class="p">,</span> <span class="s1">''</span> <span class="p">])</span>
<span class="p">})</span>
</code></pre></div> <p>I was fiddling with <code class="highlighter-rouge">try/catch</code> blocks at first and <code class="highlighter-rouge">done()</code> but apparently we can just use the regular <code class="highlighter-rouge">expect()</code> callback which makes sense seeing as you can almost treat <code class="highlighter-rouge">await</code>-ed functions like a regular synchronous functions.</p> <p>This raises the question about how to test thrown errors however. I fiddled around a bit and using the above gives you no real way to do that. One possible solution doesn’t require too much extra code though:</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should throw an error when given an invalid module name'</span><span class="p">,</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">fetchDependenciesFromNPM</span><span class="p">(</span><span class="s1">'blahblah'</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'404 Not Found'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div> <p>I’m not exactly sure if it’s best practice but it works™. I’ll let you know if I have a realisation in the future that it’s all wrong!</p> <br> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2017/async/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2017/async/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/2017/async/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <nav class="pagination"> <a href="http://localhost:4000/2017/pointers/" class="pagination_pager" title="Pointers ">previous</a> <a href="http://localhost:4000/2017/discord/" class="pagination_pager" title="Discord is down? ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-25776766-13', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <div class="overlay"> <ul class="projects-menu"> </ul> </div> </body> </html>
